<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stained Glass Documentation Tool</title>
    <meta name="description" content="Document, preserve, and share knowledge about stained glass heritage with structured metadata export capabilities.">
    <meta name="keywords" content="stained glass, cultural heritage, art history, documentation, research tool">
    <meta name="author" content="Stained Glass Documentation Tool">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèõÔ∏è</text></svg>">
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="container">
        <header>
            <h1>Stained Glass Documentation Tool</h1>
            <p>Document, preserve, and share knowledge about stained glass heritage</p>
        </header>

        <nav class="main-nav" role="navigation" aria-label="Main navigation">
            <button onclick="showView('list')" aria-label="View documented windows">
                <span aria-hidden="true">üìã</span> View Windows
            </button>
            <button onclick="showView('form')" aria-label="Add new window">
                <span aria-hidden="true">‚ûï</span> Add Window
            </button>
            <button onclick="importWikidataFile()" aria-label="Import from Wikidata">
                <span aria-hidden="true">üì•</span> Import Wikidata
            </button>
            <button onclick="importCSVFile()" aria-label="Import from CSV">
                <span aria-hidden="true">üìÑ</span> Import CSV
            </button>
            <button onclick="exportData()" aria-label="Export as JSON-LD">
                <span aria-hidden="true">üíæ</span> Export JSON-LD
            </button>
            <button onclick="exportCSV()" aria-label="Export as CSV">
                <span aria-hidden="true">üìä</span> Export CSV
            </button>
            <button onclick="showView('about')" aria-label="About this tool">
                <span aria-hidden="true">‚ÑπÔ∏è</span> About
            </button>
        </nav>

        <div id="status-message" aria-live="polite"></div>

        <main id="main-content">
            <!-- List View -->
            <div id="list-view" class="view active">
                <div class="view-header">
                    <h2>Documented Windows</h2>
                    <div class="search-container">
                        <div class="search-box">
                            <input 
                                type="text" 
                                id="search-input" 
                                placeholder="Search windows..." 
                                aria-label="Search windows by title, location, or description"
                                autocomplete="off"
                            >
                            <button 
                                type="button" 
                                class="search-clear" 
                                onclick="clearSearch()" 
                                aria-label="Clear search"
                                style="display: none;"
                            >
                                <span aria-hidden="true">‚úï</span>
                            </button>
                        </div>
                        <div id="search-status" class="search-status" aria-live="polite"></div>
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-windows">0</div>
                        <div class="stat-label">Total Windows</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="countries-count">0</div>
                        <div class="stat-label">Countries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="date-range">-</div>
                        <div class="stat-label">Date Range</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="storage-usage">-</div>
                        <div class="stat-label">Storage Used</div>
                    </div>
                </div>

                <div id="windows-list" class="window-list" role="region" aria-label="List of documented windows"></div>
            </div>

            <!-- Form View -->
            <div id="form-view" class="view">
                <div class="view-header">
                    <h2 id="form-title">Add New Window</h2>
                    <div class="form-help">
                        <p>Fields marked with <span class="required">*</span> are required</p>
                    </div>
                </div>

                <form id="window-form" novalidate>
                    <fieldset>
                        <legend class="sr-only">Basic Window Information</legend>
                        
                        <div class="form-group">
                            <label for="title">Window Title <span class="required" aria-label="required">*</span></label>
                            <input 
                                type="text" 
                                id="title" 
                                name="title" 
                                required 
                                aria-describedby="title-help"
                                autocomplete="off"
                            >
                            <small id="title-help" class="help-text">A descriptive name for this window</small>
                        </div>

                        <div class="form-group">
                            <label for="building">Building/Institution <span class="required" aria-label="required">*</span></label>
                            <input 
                                type="text" 
                                id="building" 
                                name="building" 
                                required 
                                aria-describedby="building-help"
                                autocomplete="off"
                            >
                            <small id="building-help" class="help-text">Church, cathedral, museum, or other building</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City <span class="required" aria-label="required">*</span></label>
                                <input 
                                    type="text" 
                                    id="city" 
                                    name="city" 
                                    required 
                                    autocomplete="address-level2"
                                >
                            </div>

                            <div class="form-group">
                                <label for="country">Country <span class="required" aria-label="required">*</span></label>
                                <input 
                                    type="text" 
                                    id="country" 
                                    name="country" 
                                    required 
                                    autocomplete="country"
                                >
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="date">Creation Date <span class="required" aria-label="required">*</span></label>
                            <input 
                                type="text" 
                                id="date" 
                                name="date" 
                                required 
                                placeholder="e.g., 1920, c. 1850, 13th century"
                                aria-describedby="date-help"
                                autocomplete="off"
                            >
                            <small id="date-help" class="help-text">Use any format that describes when the window was created</small>
                        </div>

                        <div class="form-group">
                            <fieldset>
                                <legend>Materials Used <span class="required" aria-label="required">*</span></legend>
                                <div class="checkbox-group" role="group" aria-describedby="materials-help">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="mat-stained-glass" name="materials" value="Stained Glass">
                                        <label for="mat-stained-glass">Stained Glass</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="mat-painted-glass" name="materials" value="Painted Glass">
                                        <label for="mat-painted-glass">Painted Glass</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="mat-clear-glass" name="materials" value="Clear Glass">
                                        <label for="mat-clear-glass">Clear Glass</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="mat-lead-came" name="materials" value="Lead Came">
                                        <label for="mat-lead-came">Lead Came</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="mat-silver-stain" name="materials" value="Silver Stain">
                                        <label for="mat-silver-stain">Silver Stain</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="mat-vitreous-paint" name="materials" value="Vitreous Paint">
                                        <label for="mat-vitreous-paint">Vitreous Paint</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="mat-other" name="materials" value="Other">
                                        <label for="mat-other">Other</label>
                                    </div>
                                </div>
                                <input 
                                    type="text" 
                                    id="materials-other" 
                                    name="materialsOther" 
                                    placeholder="Specify other materials" 
                                    style="margin-top: 0.5rem; display: none;"
                                    aria-label="Other materials"
                                >
                                <small id="materials-help" class="help-text">Select all materials that apply</small>
                            </fieldset>
                        </div>
                    </fieldset>

                    <div class="optional-section">
                        <button 
                            type="button" 
                            class="optional-toggle" 
                            onclick="toggleOptionalFields()"
                            aria-expanded="false"
                            aria-controls="optional-fields"
                        >
                            <span id="optional-toggle-text">Show Optional Fields</span>
                            <span class="toggle-icon" aria-hidden="true">‚ñº</span>
                        </button>
                        
                        <div id="optional-fields" class="optional-fields">
                            <fieldset>
                                <legend class="sr-only">Optional Window Details</legend>
                                
                                <div class="form-group">
                                    <label for="alternative-titles">Alternative Titles</label>
                                    <input 
                                        type="text" 
                                        id="alternative-titles" 
                                        name="alternativeTitles" 
                                        placeholder="Separate multiple titles with commas"
                                        aria-describedby="alt-titles-help"
                                        autocomplete="off"
                                    >
                                    <small id="alt-titles-help" class="help-text">Other names this window is known by</small>
                                </div>

                                <div class="form-group">
                                    <label for="specific-location">Specific Location within Building</label>
                                    <input 
                                        type="text" 
                                        id="specific-location" 
                                        name="specificLocation" 
                                        placeholder="e.g., North transept, Chapel of St. Mary"
                                        aria-describedby="location-help"
                                        autocomplete="off"
                                    >
                                    <small id="location-help" class="help-text">More precise location within the building</small>
                                </div>

                                <div class="form-group">
                                    <label>Dimensions</label>
                                    <div class="dimensions-group">
                                        <div class="dimension-input">
                                            <label for="width" class="sr-only">Width</label>
                                            <input 
                                                type="number" 
                                                id="width" 
                                                name="width" 
                                                placeholder="Width" 
                                                step="0.1"
                                                min="0"
                                                aria-label="Width"
                                            >
                                        </div>
                                        <div class="dimension-input">
                                            <label for="height" class="sr-only">Height</label>
                                            <input 
                                                type="number" 
                                                id="height" 
                                                name="height" 
                                                placeholder="Height" 
                                                step="0.1"
                                                min="0"
                                                aria-label="Height"
                                            >
                                        </div>
                                        <div class="dimension-input">
                                            <label for="dimension-unit" class="sr-only">Unit</label>
                                            <select id="dimension-unit" name="dimensionUnit" aria-label="Dimension unit">
                                                <option value="cm">cm</option>
                                                <option value="m">m</option>
                                                <option value="in">in</option>
                                                <option value="ft">ft</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="image-url">Image URL</label>
                                    <input 
                                        type="url" 
                                        id="image-url" 
                                        name="imageUrl" 
                                        placeholder="https://commons.wikimedia.org/wiki/Special:FilePath/..."
                                        aria-describedby="image-help"
                                        autocomplete="off"
                                    >
                                    <small id="image-help" class="help-text">
                                        Wikimedia Commons image URL (will be displayed as thumbnail)
                                    </small>
                                    <div id="image-preview" class="image-preview"></div>
                                </div>

                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <textarea 
                                        id="description" 
                                        name="description" 
                                        placeholder="Describe the window's iconography, style, condition, or other notable features"
                                        aria-describedby="description-help"
                                        rows="4"
                                    ></textarea>
                                    <small id="description-help" class="help-text">Detailed description of the window's appearance and significance</small>
                                </div>

                                <div class="form-group">
                                    <label for="subject-tags">Subject/Iconography Tags</label>
                                    <input 
                                        type="text" 
                                        id="subject-tags" 
                                        name="subjectTags" 
                                        placeholder="e.g., Christ, Virgin Mary, saints, biblical scenes (separate with commas)"
                                        aria-describedby="tags-help"
                                        autocomplete="off"
                                    >
                                    <small id="tags-help" class="help-text">Keywords describing the window's subject matter</small>
                                </div>
                            </fieldset>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" id="save-btn" class="btn-primary">
                            <span aria-hidden="true">üíæ</span> Save Window
                        </button>
                        <button type="button" class="btn-secondary" onclick="resetForm()">
                            <span aria-hidden="true">üîÑ</span> Clear Form
                        </button>
                        <button type="button" class="btn-secondary" onclick="showView('list')">
                            <span aria-hidden="true">‚ùå</span> Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- About View -->
            <div id="about-view" class="view">
                <div class="view-header">
                    <h2>About This Tool</h2>
                </div>
                
                <div class="about-content">
                    <section aria-labelledby="about-overview">
                        <h3 id="about-overview">Overview</h3>
                        <p>This tool helps researchers document stained glass windows with structured metadata that can be exported in standard formats for long-term preservation and sharing.</p>
                    </section>

                    <section aria-labelledby="about-features">
                        <h3 id="about-features">Features</h3>
                        <ul>
                            <li><strong>Complete offline functionality</strong> - No internet connection required</li>
                            <li><strong>Standards-compliant export</strong> - JSON-LD and CSV formats following Schema.org</li>
                            <li><strong>Browser-based storage</strong> - Your data stays securely on your device</li>
                            <li><strong>Import capabilities</strong> - Wikidata and CSV import support</li>
                            <li><strong>Real-time search</strong> - Find windows quickly as your collection grows</li>
                            <li><strong>Image support</strong> - Display and manage images with lazy loading</li>
                            <li><strong>Responsive design</strong> - Works on desktop, tablet, and mobile devices</li>
                            <li><strong>Accessible interface</strong> - Full keyboard navigation and screen reader support</li>
                            <li><strong>Auto-save</strong> - Automatic draft saving prevents data loss</li>
                        </ul>
                    </section>

                    <section aria-labelledby="about-getting-started">
                        <h3 id="about-getting-started">Getting Started</h3>
                        <ol>
                            <li>Click <strong>"Add Window"</strong> to create your first record</li>
                            <li>Fill in the required fields (marked with <span class="required">*</span>)</li>
                            <li>Expand optional fields for additional detail</li>
                            <li>Add image URLs from Wikimedia Commons if available</li>
                            <li>Save your record and repeat for other windows</li>
                            <li>Use the search box to find specific windows</li>
                            <li>Export your data anytime in JSON-LD or CSV format</li>
                        </ol>
                    </section>

                    <section aria-labelledby="about-import-export">
                        <h3 id="about-import-export">Import & Export</h3>
                        <h4>Export Options:</h4>
                        <ul>
                            <li><strong>JSON-LD</strong> - Standards-compliant format following Schema.org for digital humanities tools</li>
                            <li><strong>CSV</strong> - Spreadsheet-friendly format for analysis and data manipulation</li>
                        </ul>
                        
                        <h4>Import Options:</h4>
                        <ul>
                            <li><strong>Wikidata</strong> - Import structured data from Wikidata exports including images</li>
                            <li><strong>CSV</strong> - Import data from spreadsheets or other systems</li>
                        </ul>
                    </section>

                    <section aria-labelledby="about-images">
                        <h3 id="about-images">Image Support</h3>
                        <ul>
                            <li><strong>Wikimedia Commons integration</strong> - Direct support for Commons image URLs</li>
                            <li><strong>Automatic thumbnails</strong> - Optimized loading for better performance</li>
                            <li><strong>Lazy loading</strong> - Images load only when needed</li>
                            <li><strong>Full-size viewing</strong> - Click images to view in modal</li>
                            <li><strong>Export support</strong> - Images included in both JSON-LD and CSV exports</li>
                        </ul>
                    </section>

                    <section aria-labelledby="about-technical">
                        <h3 id="about-technical">Technical Information</h3>
                        <ul>
                            <li><strong>Technology:</strong> HTML5, CSS3, JavaScript (ES6+)</li>
                            <li><strong>Dependencies:</strong> None - completely self-contained</li>
                            <li><strong>Browser Support:</strong> Chrome 90+, Firefox 88+, Safari 14+, Edge 90+</li>
                            <li><strong>Storage:</strong> Browser localStorage (typically 5-10MB available)</li>
                            <li><strong>Privacy:</strong> All data stored locally, no external servers</li>
                            <li><strong>Performance:</strong> Intersection Observer API for efficient image loading</li>
                        </ul>
                    </section>

                    <section aria-labelledby="about-keyboard">
                        <h3 id="about-keyboard">Keyboard Shortcuts</h3>
                        <ul>
                            <li><strong>Ctrl+S (Cmd+S on Mac):</strong> Save current form</li>
                            <li><strong>Escape:</strong> Close modal or clear search</li>
                            <li><strong>Tab:</strong> Navigate between form fields</li>
                            <li><strong>Enter:</strong> Submit form or activate buttons</li>
                            <li><strong>Space:</strong> Toggle checkboxes and buttons</li>
                        </ul>
                    </section>

                    <section aria-labelledby="about-version">
                        <h3 id="about-version">Version Information</h3>
                        <p><strong>Version:</strong> 1.1 with Image Support<br>
                        <strong>Last Updated:</strong> <span id="last-updated">2025</span><br>
                        <strong>License:</strong> Open Source</p>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" role="dialog" aria-labelledby="delete-modal-title" aria-hidden="true">
        <div class="modal-content">
            <h3 id="delete-modal-title">Confirm Delete</h3>
            <p>Are you sure you want to delete this window record? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn-danger" onclick="confirmDelete()">
                    <span aria-hidden="true">üóëÔ∏è</span> Delete
                </button>
                <button class="btn-secondary" onclick="closeModal()">
                    <span aria-hidden="true">‚ùå</span> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="image-modal" role="dialog" aria-labelledby="modal-caption" aria-hidden="true">
        <div class="modal-image-container">
            <button class="modal-close" onclick="closeImageModal()" aria-label="Close image">
                <span aria-hidden="true">&times;</span>
            </button>
            <img id="modal-image" class="modal-image" src="" alt="" tabindex="0">
            <div id="modal-caption" class="modal-caption"></div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading-indicator" aria-hidden="true">
        <div class="spinner"></div>
        <p>Processing...</p>
    </div>

    <script src="app.js"></script>
    <script src="import-export.js"></script>

    <script>
        // Set last updated date
        document.getElementById('last-updated').textContent = new Date().getFullYear();
        
        // Update search clear button visibility
        document.getElementById('search-input').addEventListener('input', function() {
            const clearButton = document.querySelector('.search-clear');
            clearButton.style.display = this.value ? 'block' : 'none';
        });

        // Image modal keyboard handling
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('image-modal');
            if (modal.style.display === 'block') {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            }
        });

        // Click outside modal to close
        document.getElementById('image-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });

        // Image URL preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            const imageUrlInput = document.getElementById('image-url');
            if (imageUrlInput) {
                imageUrlInput.addEventListener('input', function() {
                    const url = this.value;
                    const preview = document.getElementById('image-preview');
                    
                    // Simple URL validation for Wikimedia Commons
                    if (url && url.includes('commons.wikimedia.org')) {
                        let thumbnailUrl = url;
                        
                        // Convert different URL formats to FilePath format
                        if (url.includes('wiki/File:')) {
                            const filename = url.split('File:')[1];
                            thumbnailUrl = `https://commons.wikimedia.org/wiki/Special:FilePath/${filename}`;
                        }
                        
                        // Add width parameter for thumbnail
                        if (thumbnailUrl.includes('Special:FilePath/')) {
                            thumbnailUrl += (thumbnailUrl.includes('?') ? '&' : '?') + 'width=200';
                        }
                        
                        preview.innerHTML = `
                            <img src="${thumbnailUrl}" 
                                 alt="Preview" 
                                 class="form-image-preview"
                                 onerror="this.style.display='none'">
                        `;
                    } else {
                        preview.innerHTML = '';
                    }
                });
            }
        });

        // Initialize image functionality when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize image observer for lazy loading
            if (typeof initializeImageObserver === 'function') {
                initializeImageObserver();
            }
        });
    </script>
</body>
</html>